<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="fisher2, 湮灭星空,博客,Python,后端">
    <meta name="description" content="天下寥寥，苍生涂涂，诸子百家，唯我纵横">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>fisher2 | 湮灭星空</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/css/my.css">

    <script src="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.2.0"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">湮灭星空</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">湮灭星空</div>
        <div class="logo-desc">
            
            天下寥寥，苍生涂涂，诸子百家，唯我纵横
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/Annihilater" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Follow Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/Annihilater" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Follow Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/medias/featureimages/3.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">fisher2</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/python/">
                                <span class="chip bg-color">python</span>
                            </a>
                        
                            <a href="/tags/flask/">
                                <span class="chip bg-color">flask</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/fisher/" class="post-category">
                                fisher
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2019-04-12
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2019-12-06
                </div>
                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>我们再来分析一下把<code>rencent</code>函数放到<code>Gift</code>模型下面的合理性？</p>
<p><code>Gift</code>模型按照我们的常规的思维可以把它理解成数据库里面的一条记录。那么既然<code>Gift</code>代表的是一条记录，一条记录里面有这样的<code>rencent</code>取最近的很多条记录会感觉非常的不合理，如果<code>rencent</code>是一个实例方法的话，放在<code>Gift</code>下面确实是不合适的，因为一个被实例化的<code>Gift</code>对象代表的是一个礼物，一个礼物里面有取多个礼物的方法确实是不合适的，但是如果说我们把<code>rencent</code>实例方法变成类方法的话，放在我们<code>Gift</code>类下面，那么就是合适的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recent</span>(<span class="params">self</span>):</span></span><br><span class="line">    recent_gift = Gift.query.filter_by(launched=<span class="literal">False</span>).group_by(</span><br><span class="line">        Gift.isbn).order_by(</span><br><span class="line">        Gift.create_time).limit(</span><br><span class="line">      current_app.config[<span class="string">&#x27;RECENT_BOOK_COUNT&#x27;</span>]).distinct().<span class="built_in">all</span>()</span><br><span class="line">    <span class="keyword">return</span> recent_gift</span><br></pre></td></tr></table></figure>

<p>将<strong>实例方法</strong>改写成<strong>类方法</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@classmethod</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recent</span>(<span class="params">cls</span>):</span></span><br><span class="line">    recent_gift = Gift.query.filter_by(launched=<span class="literal">False</span>).group_by(</span><br><span class="line">        Gift.isbn).order_by(</span><br><span class="line">        Gift.create_time).limit(</span><br><span class="line">        current_app.config[<span class="string">&#x27;RECENT_BOOK_COUNT&#x27;</span>]).distinct().<span class="built_in">all</span>()</span><br><span class="line">    <span class="keyword">return</span> recent_gift</span><br></pre></td></tr></table></figure>

<p>因为对象具体到一个礼物，但是类确实代表自然界里的一个事物，它是抽象的，并不是具体的<strong>一个</strong>，而我们实例方法是和对象对应的，类方法是和类对应的。最近的礼物确实可以属于礼物这个<code>事物</code>的，但是呢它不应该属于具体的某一个礼物，这个就是对<code>类</code>和<code>对象</code>的一个深入的思考，这种写法也是对类和对象的具体的应用。</p>
<p>之前我们说了，<code>rencet</code>除了写在<code>Gift</code>之外还可以写在其他地方，<code>rencet</code>函数的实质其实就是做了一次<code>SQL</code>的查询，既然这样那我们也可以把这次查询写到视图函数里面，但是这种方法不推荐，最推荐的还是把<code>rencet</code>集中到<code>Gift</code>模型下面来。</p>
<ul>
<li><strong>总结</strong>：有具体业务意义的代码不要放在视图函数里<ul>
<li>如果你的代码能够提取出具体的业务意义，建议放到模型下面</li>
<li>如果你的代码不能够提取出具体的业务意义，确实可以放到视图函数里面另一种<code>rencet</code>的写法：</li>
</ul>
</li>
</ul>
<p>我们可以把获取最近上传的书籍作为一个新的模型为它单独新建一个模型文件例如：<code>RencentGift</code>。</p>
<h3 id="编写我的赠送清单页面（my-gifts页面）"><a href="#编写我的赠送清单页面（my-gifts页面）" class="headerlink" title="编写我的赠送清单页面（my_gifts页面）"></a>编写我的赠送清单页面（<code>my_gifts</code>页面）</h3><p><img src="https://klause-blog-pictures.oss-cn-shanghai.aliyuncs.com/2019-05-14-144136.jpg" alt="image-20180914221202396"></p>
<p><img src="https://klause-blog-pictures.oss-cn-shanghai.aliyuncs.com/2019-05-14-144138.jpg" alt="image-20180914221055232"></p>
<p>在理清赠送清单页面逻辑的时候，根据多年的经验，可以想到有两种编写方式（如上图）。</p>
<ul>
<li>第一种，我们肯定是需要查询出<strong>我的所有礼物</strong>，然后再遍历<strong>我的所有礼物</strong>，根据书籍的<code>isbn</code>编号去查询这本书籍的心愿数量，假定一本书籍的心愿数为<code>N</code>，那么这种方法需要查询数据库的次数：<code>N+1</code>，因为<code>N</code>不可控<ul>
<li>优点：思路简单</li>
<li>缺点：循环遍历数据库是不可以接受的</li>
</ul>
</li>
<li>第二种，先查询出<strong>我的所有礼物</strong>，将所有书籍的<code>isbn</code>编号取出来组成一个列表，然后使用<code>mysql</code>的<code>in</code>查询去<code>Wish</code>表中查询所有属于<code>isbn</code>列表中的心愿，并计算其数量<ul>
<li>优点：<code>2</code>次数据库的查询</li>
<li>缺点：代码复杂</li>
</ul>
</li>
</ul>
<h3 id="db-session查询"><a href="#db-session查询" class="headerlink" title="db.session查询"></a><code>db.session</code>查询</h3><p><code>db.session.query(Wish)</code>需要传入查询的主体，这里我们需要在<code>Wish</code>表中查询所以使用<code>Wish</code></p>
<h4 id="filter与filter-by的区别："><a href="#filter与filter-by的区别：" class="headerlink" title="filter与filter_by的区别："></a><code>filter</code>与<code>filter_by</code>的区别：</h4><ul>
<li><p><code>filter_by</code>内部的实质是调用<code>filter</code>。<code>filter_by</code>传入的是关键字参数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Gift.query.filter_by(launched=<span class="literal">False</span>, uid=uid)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>filter</code>比<code>filter_by</code>更加灵活、强大。<code>filter</code>接收的是条件表达式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.session.query(Wish).<span class="built_in">filter</span>(Wish.launched == <span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="如何通过sqlalchemy来做mysql的in查询"><a href="#如何通过sqlalchemy来做mysql的in查询" class="headerlink" title="如何通过sqlalchemy来做mysql的in查询"></a>如何通过<code>sqlalchemy</code>来做<code>mysql</code>的<code>in</code>查询</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">使用示例：Wish.isbn.in_(isbn_list)</span><br><span class="line"></span><br><span class="line">db.session.query(Wish).<span class="built_in">filter</span>(Wish.launched == <span class="literal">False</span>,</span><br><span class="line">                              Wish.isbn.in_(isbn_list),</span><br><span class="line">                              Wish.status == <span class="number">1</span>).<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>





<h4 id="函数返回的数据结构"><a href="#函数返回的数据结构" class="headerlink" title="函数返回的数据结构"></a>函数返回的数据结构</h4><p>非常不建议直接在函数中返回元组或者列表的数据结构，</p>
<ul>
<li>建议返回<strong>对象</strong>，因为对象是有属性的，每个属性是有具体意义的。</li>
<li>最经典的数据结构：字典。</li>
</ul>
<h4 id="python中有快速定义对象的方法：namedtuple"><a href="#python中有快速定义对象的方法：namedtuple" class="headerlink" title="python中有快速定义对象的方法：namedtuple"></a><code>python</code>中有快速定义对象的方法：<code>namedtuple</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义对象</span></span><br><span class="line">EachGiftWishCount = namedtuple(<span class="string">&#x27;EachGiftWithCount&#x27;</span>, [<span class="string">&#x27;count&#x27;</span>, <span class="string">&#x27;isbn&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用方法，这里的count_list是一个元组的列表，列表里每个元素都是一个元组</span></span><br><span class="line">count_list = [EachGiftWithCount(w[<span class="number">0</span>], w[<span class="number">1</span>]) <span class="keyword">for</span> w <span class="keyword">in</span> count_list]</span><br></pre></td></tr></table></figure>

<p><code>namedtuple</code>接收第一个字符串，这个字符串就是你定义的对象的名字，后面是一个列表，这个列表代表了你定义的对象下面的相关属性，最后将其赋给<code>EachGiftWithCount</code>这个变量。</p>
<h4 id="db-session-query查询方式和Gift-query-filter-by模型查询方式的区别"><a href="#db-session-query查询方式和Gift-query-filter-by模型查询方式的区别" class="headerlink" title="db.session.query查询方式和Gift.query.filter_by模型查询方式的区别"></a><code>db.session.query</code>查询方式和<code>Gift.query.filter_by</code>模型查询方式的区别</h4><ul>
<li>如果单纯的就是查询模型的话，显然使用<code>Gift.query.filter_by</code>模型查询最为快速的</li>
<li>如果查询比较复杂，或者说涉及到跨表查询、跨模型查询的时候，<code>db.session.query</code>这种查询方式是更好的。</li>
</ul>
<h4 id="多层嵌套的for-in循环"><a href="#多层嵌套的for-in循环" class="headerlink" title="多层嵌套的for in循环"></a>多层嵌套的<code>for in</code>循环</h4><p>代码大全里介绍到我们可以将第二个<code>for in</code>循环提出来作为一个单独的函数来写，然后在第一个<code>for in</code>循环内调用该函数</p>
<blockquote>
<p>小技巧：</p>
<p>不建议在方法里面修改实例变量，原因很简单，如果你直接在类的某一个方法里直接修改实例属性的话，那么就会存在问题。当你的类很复杂，方法很多的时候，你根本不知道实例属性会在哪个方法中被修改，但是读取实例属性是没有关系的，因为读取不会修改实例属性的值。</p>
<ul>
<li><p>直接在类的方法里修改类的实例属性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyGifts</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, gifts_of_mine, wish_count_list</span>):</span></span><br><span class="line">        self.gifts = []</span><br><span class="line"></span><br><span class="line">        self.__gifts_of_mine = gifts_of_mine</span><br><span class="line">        self.__wish_count_list = wish_count_list</span><br><span class="line"></span><br><span class="line">        self.__parse()	<span class="comment"># 调用__parse方法，否则没用</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__parse</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">for</span> gift <span class="keyword">in</span> self.__gifts_of_mine:</span><br><span class="line">            my_gift = self.__matching(gift)</span><br><span class="line">            self.gifts.append(my_gift)</span><br><span class="line">        <span class="keyword">return</span> self.gifts</span><br></pre></td></tr></table></figure>
</li>
<li><p>不在类的方法里修改类的属性，而是应该在方法里将结果返回，在构造函数内修改实例属性的值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyGifts</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, gifts_of_mine, wish_count_list</span>):</span></span><br><span class="line">        self.gifts = []</span><br><span class="line"></span><br><span class="line">        self.__gifts_of_mine = gifts_of_mine</span><br><span class="line">        self.__wish_count_list = wish_count_list</span><br><span class="line"></span><br><span class="line">        self.gifts = self.__parse()	<span class="comment"># 调用__parse方法，否则没用</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__parse</span>(<span class="params">self</span>):</span></span><br><span class="line">        tem_gifts = []</span><br><span class="line">        <span class="keyword">for</span> gift <span class="keyword">in</span> self.__gifts_of_mine:</span><br><span class="line">            my_gift = self.__matching(gift)</span><br><span class="line">            tem_gifts.append(my_gift)</span><br><span class="line">        <span class="keyword">return</span> tem_gifts</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>请看以上两种方式的区别。</p>
</blockquote>
<h4 id="用户注销"><a href="#用户注销" class="headerlink" title="用户注销"></a>用户注销</h4><p>使用<code>logout_user</code>函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_login <span class="keyword">import</span> login_user, logout_user</span><br><span class="line"></span><br><span class="line"><span class="meta">@web.route(<span class="params"><span class="string">&#x27;/logout&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span>():</span></span><br><span class="line">    logout_user()</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;web.index&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p><code>logout_user</code> 其实就是将浏览器的 <code>cookie</code> 清空</p>
<h3 id="再遇循环引用"><a href="#再遇循环引用" class="headerlink" title="再遇循环引用"></a>再遇循环引用</h3><p><code>python</code>里的循环导入为什么头疼主要是因为<code>python</code>不会直接在总结性的信息里告诉你<strong>这是一个由于循环导入所引起的问题</strong>。所以这就要求开发者有丰富的经验，要对常见的由于循环导入所引起的问题有一个很敏感的意识。</p>
<blockquote>
<p>七月心语：</p>
<p>循环导入是<code>python</code>中常见的问题，和设计没有关系，出现循环导入是一种很正常的现象，我从来都不认为，出现循环导入是你的设计做得不够好，网上很多教程都说出现循环导入就是你的设计不够好，我从来不这么认为。因为我们从面向对象的角度来看，出现循环导入是很正常的，举个例子：你和你的对象，你们之间痛苦的时候会互相倾述，开心的时候会相互分享，这是正常相互作用的关系。那放在我们代码里面来说，两个对象之间也会有相互作用的关系，那么它就会存在这样的循环导入。</p>
</blockquote>
<p>循环导入的原因：</p>
<p>​    第一次从<strong>模块一</strong>导入的时候，先进入模块一，在走到<strong>需要导入的类</strong>之前又遇到其他导入语句，所以立马跳到<strong>模块二</strong>，所以之前<strong>需要导入的类</strong>并没有导入，等到第二次需要导入该类的时候，因为<code>python</code>以为第一次已经导入过了，所以就不会执行导入语句，会直接从缓存中查找，但是由于之前并没有实际导入，所以找不到报错<code>can&#39;t import</code></p>
<p>解决方法：</p>
<ol>
<li>将导致循环导入的语句放到不能导入的类的下方<br>等先执行这个类的导入之后在执行导入语句，那么后面再次导入该类的时候就能找到该类了</li>
<li>在需要调用的时候导入一下，在哪里用就在那里导入</li>
</ol>
<p>两种方法都可以，七月老师更喜欢第二种方法，那就第二种吧。</p>
<blockquote>
<p>小技巧：</p>
<p>当你遇到一个错误的时候，第一件事情就是把整个错误信息拖到最下面看最后的总结性的错误提示，绝大多数情况下，根据总结性的错误提示，我们其实就可以找到错误的原因，如果根据错误提示你找不到原因的话，那么就需要从下往上看具体的<strong>错误堆栈信息</strong>。</p>
<p><img src="https://klause-blog-pictures.oss-cn-shanghai.aliyuncs.com/2019-05-14-144142.jpg" alt="image-20180914190211450"></p>
</blockquote>
<h3 id="重复代码的封装技巧"><a href="#重复代码的封装技巧" class="headerlink" title="重复代码的封装技巧"></a>重复代码的封装技巧</h3><p>我们来谈一谈<code>MyTrades</code>的意义：</p>
<p>表面上来看<code>MyTrades</code>只是将原来的<code>MyGifts</code>、<code>MyWishes</code>合并成了一段代码，但是严格意义上来说<code>MyTrades</code>实际上是<code>MyGifts</code>和<code>MyWishes</code>的基类，鱼书项目中之所以没有体现出<code>MyTrades</code>作为基类的特性（被继承）在于<code>MyWishes</code>和<code>MyWishes</code>的业务逻辑是一模一样的，所以我们是可以使用基类来代替这两个子类的。</p>
<p>需要强调的是，如果<code>MyGifts</code>和<code>MyWishes</code>出现了行为逻辑上的差异的话，那么我们就需要单独定义<code>MyGifts</code>和<code>MyWishes</code>去继承<code>MyTrades</code>，然后在子类里面去实现自己特定的业务逻辑。</p>
<blockquote>
<p>小技巧：</p>
<p>关于模型命名的问题，模型的命名需要经过慎重的思考，英语的重要性在这里就体现出来了，一定要找到一个比较合适而又简洁的命名。</p>
<p>这样才会让你的代码编写更加轻松！</p>
<p><img src="https://klause-blog-pictures.oss-cn-shanghai.aliyuncs.com/2019-05-14-144148.jpg" alt="image-20180914210839118"></p>
</blockquote>
<h3 id="忘记密码"><a href="#忘记密码" class="headerlink" title="忘记密码"></a>忘记密码</h3><h4 id="first-or-404"><a href="#first-or-404" class="headerlink" title="first_or_404()"></a><code>first_or_404()</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@web.route(<span class="params"><span class="string">&#x27;/reset/password&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">forget_password_request</span>():</span></span><br><span class="line">    form = EmailForm(request.form)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span> <span class="keyword">and</span> form.validate():</span><br><span class="line">        count_email = form.email.data</span><br><span class="line">        user = User.query.filter_by(email=count_email).first_or_404()</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;auth/forget_password_request.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>上面代码使用的是<code>first_or_404()</code>：</p>
<ul>
<li><p>在<code>filter_by（）</code>后面使用的是<code>first（）</code>，如果这次查询没有找到任何结果，那么这个<code>user</code>将会被赋予<strong>空值</strong>，后面的流程会继续往下面执行。</p>
</li>
<li><p>在<code>filter_by</code>后面使用的是<code>first_or_404()</code>，如果查询不到任何结果的话，后续代码将不会被执行。因为在<code>first_or_404()</code>方法的内部会抛出一个异常，终止代码运行。</p>
</li>
</ul>
<p><img src="https://klause-blog-pictures.oss-cn-shanghai.aliyuncs.com/2019-05-14-144151.jpg" alt="image-20180915182020249"></p>
<p>最终返回的是<code>Notfound</code>对象，<code>Notfound</code>下面的<code>description</code>与最终页面返回的描述一模一样，为什么呢？</p>
<p>页面输出什么完全取决于<code>response</code>响应对象。根据这样的理论，我们可以推测，最终构建的<code>response</code>响应对象一定读取了<code>Notfound</code>下面的<code>description</code>。</p>
<p>当我们调用<code>first_or_404()</code>之后会抛出一个异常，异常之后的代码都不会被执行，也就是最终构建的<code>response</code>对象一定不是从视图函数的<code>return</code>语句里构建的，那么这个<code>response</code>在哪构建的呢？</p>
<p>在基类<code>HTTPException</code>里面定义了一个方法<code>get_response</code>，异常<code>response</code>就是在这里构建的。</p>
<blockquote>
<p>七月心语：</p>
<p>大家需要充分了解异常对象，特别是对象的基类<code>HTTPException</code>，原因在于，如果你需要用<code>flask</code>去做一个比较好的<code>restful api</code>，那么就需要重写<code>HTTPException</code>。我们下一门课程讲<strong>restful标准API</strong>的时候，大家就会发现重写<code>HTTPException</code>将会是最优雅、最好的<code>restful</code>异常的实现。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotFound</span>(<span class="params">HTTPException</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;&quot;&quot;*404* `Not Found`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Raise if a resource does not exist and never existed.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    code = <span class="number">404</span></span><br><span class="line">    description = (</span><br><span class="line">        <span class="string">&#x27;The requested URL was not found on the server.  &#x27;</span></span><br><span class="line">        <span class="string">&#x27;If you entered the URL manually please check your spelling and &#x27;</span></span><br><span class="line">        <span class="string">&#x27;try again.&#x27;</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure>



<blockquote>
<p>小技巧：</p>
<p>如果一段<code>python</code>代码中间的某一处抛出了异常之后，这个异常之后的代码是不会被继续执行的。</p>
</blockquote>
<blockquote>
<p>小技巧：</p>
<p>==如果以后需要扫描一个文件或者说一个模块下面所有对象的话，可以借鉴<code>_find_exceptions</code>的实现方法。==</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">default_exceptions = &#123;&#125;</span><br><span class="line">__all__ = [<span class="string">&#x27;HTTPException&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_find_exceptions</span>():</span></span><br><span class="line">    <span class="keyword">for</span> name, obj <span class="keyword">in</span> iteritems(<span class="built_in">globals</span>()):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            is_http_exception = <span class="built_in">issubclass</span>(obj, HTTPException)</span><br><span class="line">        <span class="keyword">except</span> TypeError:</span><br><span class="line">            is_http_exception = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> is_http_exception <span class="keyword">or</span> obj.code <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        __all__.append(obj.__name__)</span><br><span class="line">        old_obj = default_exceptions.get(obj.code, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> old_obj <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="built_in">issubclass</span>(obj, old_obj):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        default_exceptions[obj.code] = obj</span><br><span class="line">_find_exceptions()</span><br><span class="line"><span class="keyword">del</span> _find_exceptions</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="app-errorhandler-装饰器"><a href="#app-errorhandler-装饰器" class="headerlink" title="@app_errorhandler()装饰器"></a><code>@app_errorhandler()</code>装饰器</h4><p>上面调用<code>first_or_404()</code>之后会出现<code>flask</code>默认的<code>404</code>页面，这样并不太友好，如果我们想返回我们自定义的页面呢？</p>
<ul>
<li><p>方案一<br>我们可以再<code>first_or_404()</code>前后加上<code>try exception</code>，当触发异常的时候使用<code>exception</code>返回自定义的页面（代码如下），确实可以得到我们想要的结果。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    user = User.query.filter_by(email=count_email).first_or_404()</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">	<span class="keyword">return</span> render_template(<span class="string">&#x27;404.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对于整个项目而言，可能有很多个地方都会出现这样的<code>404</code>异常，那么像这样每个地方都要写这样的一段代码是不是很繁琐？有没有好的解决方案呢？</p>
</blockquote>
</li>
<li><h4 id="方案二（学习重点）"><a href="#方案二（学习重点）" class="headerlink" title="方案二（学习重点）"></a>方案二（学习重点）</h4><p>我们只需要在蓝图的初始文件里构造这样一个带<code>@app_errorhandler</code>装饰器的<code>not_found</code>函数就可以了，这样就可以实现监控所有状态码为<code>404</code>的<code>http</code>异常，从而实现返回自定义的页面，当然也不一定必须返回<code>404</code>，因为在<code>not_found</code>里是可以实现任意代码需求的，可以在这里进行更加细致的处理。比如：记录具体的异常信息到日志里，那么就从参数<code>e</code>里读取异常信息并且写入到日志。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template</span><br><span class="line"></span><br><span class="line"><span class="meta">@web.app_errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">not_found</span>(<span class="params">e</span>):</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;404.html&#x27;</span>), <span class="number">404</span></span><br></pre></td></tr></table></figure>

<ul>
<li>如果没有使用蓝图的话，在<code>flask</code>核心对象<code>app</code>里也同样有<code>@app_errorhandler</code>装饰器，这就是七月老师常说的，蓝图的很多方法和<code>flask</code>核心对象是一模一样的。</li>
</ul>
</li>
</ul>
<p><code>@app_errorhandler()</code>装饰器接收一个状态码参数，接收什么就监控什么。</p>
<h4 id="AOP思想的应用"><a href="#AOP思想的应用" class="headerlink" title="AOP思想的应用"></a><code>AOP</code>思想的应用</h4><p><code>AOP</code>思想其实就是<strong>面向切片编程</strong>。</p>
<p>大体意思就是我们不要在每一个可能会出现<code>404</code>的地方去处理异常，而是把所有的处理的代码集中到一个地方处理。上面<code>@app_errorhandler()</code>装饰器就是一种基于<code>AOP</code>思想的应用。这个<code>AOP</code>思想的实现是借助于<code>flask</code>已经帮我们写好的<code>@app_errorhandler()</code>装饰器。</p>
<blockquote>
<p>七月心语：</p>
<p>建议大家以后在写框架类型的代码的时候，如果你追求这样一种非常好的编码方式的话，那么你也要能考虑到我可不可以自己来写一个装饰器，来实现这种统一的、集中式的处理。</p>
</blockquote>
<h4 id="可调用对象的意义"><a href="#可调用对象的意义" class="headerlink" title="可调用对象的意义"></a>可调用对象的意义</h4><p>一般来说，函数或者方法可以通过传递参数进行调用，但是对象不可以。</p>
<p>==如果你想把一个对象当做函数来调用，那么这个对象内部必须实现一个特殊的方法，<code>__call__</code>方法。一旦我们在一个类的内部实现了这个特殊的<code>__call__</code>方法之后，我们就可以把这个对象当做函数来调用。==</p>
<blockquote>
<p>下面代码实质上就是调用了<code>Aborter</code>类的<code>__call__</code>方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">abort</span>(<span class="params">status, *args, **kwargs</span>):</span></span><br><span class="line">    <span class="keyword">return</span> _aborter(status, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">_aborter = Aborter()</span><br><span class="line"></span><br><span class="line">---------------------------------------------------------------------------------------</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Aborter</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, mapping=<span class="literal">None</span>, extra=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> mapping <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            mapping = default_exceptions</span><br><span class="line">        self.mapping = <span class="built_in">dict</span>(mapping)</span><br><span class="line">        <span class="keyword">if</span> extra <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.mapping.update(extra)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, code, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> args <span class="keyword">and</span> <span class="keyword">not</span> kwargs <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(code, integer_types):</span><br><span class="line">            <span class="keyword">raise</span> HTTPException(response=code)</span><br><span class="line">        <span class="keyword">if</span> code <span class="keyword">not</span> <span class="keyword">in</span> self.mapping:</span><br><span class="line">            <span class="keyword">raise</span> LookupError(<span class="string">&#x27;no exception for %r&#x27;</span> % code)</span><br><span class="line">        <span class="keyword">raise</span> self.mapping[code](*args, **kwargs)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>对于这种可以被当做函数直接来调用的对象，我们称作<strong>可调用对象</strong>。可调用对象的实质就是在它的内部实现<code>__call__</code>方法。</p>
<p>可调用对象在普通编程的时候是用不到的，只有在做一些比较抽象的编程的时候才会发现它的用处。</p>
<p><img src="https://klause-blog-pictures.oss-cn-shanghai.aliyuncs.com/2019-05-14-144153.jpg" alt="image-20180915173654191"></p>
<blockquote>
<p>可调用对象作为统一调用的接口的实例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">go</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">object</span>()</span><br><span class="line"><span class="comment"># 实例化A为对象</span></span><br><span class="line">a = A()</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">object</span>()</span><br><span class="line"><span class="comment"># 实例化B为对象</span></span><br><span class="line">b = B()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">object</span>()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params"><span class="built_in">callable</span></span>):</span></span><br><span class="line">	<span class="built_in">callable</span>()</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">main(A())</span><br><span class="line">main(B())</span><br><span class="line">main(func)</span><br></pre></td></tr></table></figure>

<p>我想在main中调用传入的参数，得到一个object对象，</p>
<p>如果传入的是对象<code>a</code>的话，<code>a.go()</code>；</p>
<p>如果传入的是对象<code>b</code>的话，<code>b.run()</code>；</p>
<p>如果传入的是函数<code>func</code>的话，<code>func()</code>；</p>
<p>关键问题在于<code>main</code>并不知道传入的参数是什么类型、具体是什么！如果<code>main</code>接收的是函数类型的话，那就很简单了，直接使用<code>param（）</code>的形式调用就可以了，那么对象<code>a</code>、<code>b</code>可不可以使用函数的调用形式呢？显然是可以的，将<code>a</code>、<code>b</code>转化为可调用对象。就可以在<code>main</code>中统一调用形式，不需要过问参数的具体类型。</p>
</blockquote>
<h4 id="发送电子邮件"><a href="#发送电子邮件" class="headerlink" title="发送电子邮件"></a>发送电子邮件</h4><h5 id="email配置"><a href="#email配置" class="headerlink" title="email配置"></a><code>email</code>配置</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MAIL_SERVER = <span class="string">&#x27;smtp.qq.com&#x27;</span></span><br><span class="line">MAIL_PORT = <span class="number">465</span></span><br><span class="line">MAIL_USE_SSL = <span class="literal">True</span></span><br><span class="line">MAIL_USE_TSL = <span class="literal">False</span></span><br><span class="line">MAIL_USERNAME = <span class="string">&#x27;schip@qq.com&#x27;</span></span><br><span class="line">MAIL_PASSWORD = <span class="string">&#x27;qfhglcwpkehyebeh&#x27;</span></span><br><span class="line"><span class="comment"># MAIL_SUBJECT_PREFIX = &#x27;[鱼书]&#x27;</span></span><br><span class="line"><span class="comment"># MAIL_SENDER = &#x27;鱼书&lt;hello@yushu.im&gt;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>参数解释：</p>
<ul>
<li><code>MAIL_SERVER</code>：指定电子邮箱服务器的地址，<code>QQ</code>的服务器地址是<code>smtp.qq.com</code><br>网站向用户发送电子邮件，理论上来说是需要一个电子邮件服务器的，但是没必要自己去搭建，可以使用公开的电子邮件服务器，比如想腾讯提供的<code>QQ</code>电子邮箱服务器、也可以使用<code>163</code>的，还有很多其他的。</li>
<li><code>MAIL_PORT</code>：指定电子邮箱服务器的端口，<code>QQ</code>的端口是<code>564</code></li>
<li><code>MAIL_USE_SSL</code>：<code>SSL</code>协议，<code>QQ</code>使用的是该协议，<code>True</code></li>
<li><code>MAIL_USE_TSL</code>：<code>TSL</code>协议，<code>QQ</code>使用的是<code>SSL</code>自然不可能再用<code>TSL</code>，<code>False</code></li>
<li><code>MAIL_USERNAME</code>：发件人邮箱地址</li>
<li><code>MAIL_PASSWORD</code>：密码，对应<code>QQ</code>电子邮箱服务器来说会生成授权码，就是这个授权码<br><img src="https://klause-blog-pictures.oss-cn-shanghai.aliyuncs.com/2019-05-14-144156.jpg" alt="image-20180916100902876"></li>
</ul>
<blockquote>
<p>七月心语：</p>
<p>学习编程要有选择性的深挖，比如像这些<code>email</code>配置，不建议深挖，因为你并不是专业从事电子邮件研发的工程师，其实你只需要掌握这些参数然后运用这些参数发送电子邮件就可以了，时间是一种非常稀缺的资源，你把时间花在研究参数上面，还不如把时间花在更有价值的地方，比如深挖<code>python</code>装饰器高级用法，相对于专研参数来说这个对你更有帮助。</p>
</blockquote>
<h5 id="任意测试邮件"><a href="#任意测试邮件" class="headerlink" title="任意测试邮件"></a>任意测试邮件</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_mail <span class="keyword">import</span> Message</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> mail</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_email</span>():</span></span><br><span class="line">    msg = Message(<span class="string">&#x27;测试邮件&#x27;</span>, sender=<span class="string">&#x27;schip@qq.com&#x27;</span>, body=<span class="string">&#x27;Test&#x27;</span>,</span><br><span class="line">                  recipients=[<span class="string">&#x27;schip@qq.com&#x27;</span>])</span><br><span class="line">    mail.send(msg)</span><br></pre></td></tr></table></figure>

<p><code>Message()</code>参数：</p>
<ul>
<li>第一个参数是邮件的标题</li>
<li><code>sender</code>：发件人</li>
<li><code>body</code>：邮件正文内容</li>
<li><code>recipients</code>：收件人</li>
</ul>
<p>调用<code>mail.send()</code>就可以进行发送测试。</p>
<h5 id="注册用户测试邮件"><a href="#注册用户测试邮件" class="headerlink" title="注册用户测试邮件"></a>注册用户测试邮件</h5><p>注册用户测试邮件就是必须要验证该邮件是否已经注册，不注册会报错，其实很简单，只需要在上述任意测试邮件里传入相应的参数就可以了，因为我们会将提交的邮件去数据库里查询使用该邮件注册的用户，如果找不到则说明该邮件没注册，会报错提示（后面继续优化）。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> current_app, render_template</span><br><span class="line"><span class="keyword">from</span> flask_mail <span class="keyword">import</span> Message</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> mail</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_email</span>(<span class="params">to, subject, template, **kwargs</span>):</span></span><br><span class="line">    msg = Message(<span class="string">&#x27;鱼书&#x27;</span>+<span class="string">&#x27;&#x27;</span>+ subject,</span><br><span class="line">                  sender=current_app.config[<span class="string">&#x27;MAIL_USERNAME&#x27;</span>],</span><br><span class="line">                  recipients=[to])</span><br><span class="line">    msg.html = render_template(template, **kwargs)</span><br><span class="line">    mail.send(msg)</span><br><span class="line">---------------------------------------------------------------------------------------</span><br><span class="line"><span class="meta">@web.route(<span class="params"><span class="string">&#x27;/reset/password&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">forget_password_request</span>():</span></span><br><span class="line">    form = EmailForm(request.form)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span> <span class="keyword">and</span> form.validate():</span><br><span class="line">        count_email = form.email.data</span><br><span class="line">        user = User.query.filter_by(email=count_email).first_or_404()</span><br><span class="line">        <span class="keyword">from</span> app.libs.email <span class="keyword">import</span> send_email</span><br><span class="line">        send_email(form.email.data, <span class="string">&#x27;重置你的密码&#x27;</span>, <span class="string">&#x27;email/reset_password.html&#x27;</span>, user=user, token=<span class="string">&#x27;123123&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;auth/forget_password_request.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><code>send_mail</code>参数解释：</p>
<ul>
<li><code>to</code>：收件人</li>
<li><code>subject</code>：邮件主题（我们在前面加上一些修饰，将其拼接成一个字符串）</li>
<li><code>template</code>：邮件模板（邮件的内容）<br>任意邮件测试的时候，我们使用的是<code>body</code>，<code>body</code>一般是用来传入一些文本的，我们知道邮件是可以被格式化的显示的，最好的格式化的方式就是在邮件里显示一段<code>html</code>代码，因为<code>html</code>是很容易格式化显示出来的。</li>
<li><code>msg.html</code>：如果我们想在邮件里面加入一段<code>html</code>作为邮件的正文的话，我们可以使用<code>html</code>参数。我们把一段<code>html</code>代码赋给<code>msg.html</code>就可以了。<br><strong>注意</strong>：此处不能直接把<code>&#39;auth/email/reset_password.html&#39;</code>的路径直接赋值给<code>msg.html</code>，因为这个模板还需要数据（变量）进行渲染，我们应该把已经渲染好的页面赋值过去。</li>
<li><code>**kwargs</code>：模板渲染的参数<br>每个模板要被数据填充渲染，肯定是要先传入这些数据。邮件内需要显示用户名、还有重置密码的链接，这些数据就是从该参数传入的。</li>
</ul>
<blockquote>
<p>注意：</p>
<p>目前使用的发件人的邮箱是我们个人的邮箱，这个可以用于我们个人开发测试，但是如果你是一个已经上线的产品的话，用个人的邮箱地址向用户发送邮件是不合适的，需要<strong>企业电子邮件</strong>。<strong>企业电子邮件</strong>必须要有一个自己注册的域名，然后按照腾讯企业邮件的设置规则去进行相应的设置就可以了。</p>
</blockquote>
<h5 id="用户新密码提交验证"><a href="#用户新密码提交验证" class="headerlink" title="用户新密码提交验证"></a>用户新密码提交验证</h5><p>在用户新密码的设置页面我们需要为用户设置的新密码进行验证，如果不符合密码规范要求展示提示信息。</p>
<p>该页面要求定义两个校验变量<code>password1</code>、<code>password2</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResetPasswordForm</span>(<span class="params">Form</span>):</span></span><br><span class="line">    password1 = PasswordField(validators=[</span><br><span class="line">        DataRequired(),</span><br><span class="line">        Length(<span class="number">6</span>, <span class="number">32</span>, message=<span class="string">&#x27;密码长度至少需要在6到32个字符之间&#x27;</span>),</span><br><span class="line">        EqualTo(<span class="string">&#x27;password2&#x27;</span>, message=<span class="string">&#x27;两次输入的密码不相同&#x27;</span>)])</span><br><span class="line">    password2 = PasswordField(validators=[</span><br><span class="line">        DataRequired(), Length(<span class="number">6</span>, <span class="number">32</span>)])</span><br></pre></td></tr></table></figure>

<p>新密码规范：</p>
<ul>
<li>密码长度需要在6到32个字符之间</li>
<li>两次输入的密码必须相同</li>
<li>进行<code>DataRrequired()</code>验证</li>
</ul>
<h5 id="token"><a href="#token" class="headerlink" title="token"></a><code>token</code></h5><p>当用户提交新密码过来之后，我们接下来要做的就很简单了，更新当前用户密码就行了。那么问题来了，当前用户是谁？用户新密码设置页面的链接是用户邮箱收到的链接，该链接并不要求用户登录，所以我们是拿不到<code>current_user</code>的。但是这个链接是包含<code>token</code>的链接，是我们在<code>forget_password_request</code>视图函数里生成的链接，我们之前就是将用户<code>id</code>加密之后放入<code>token</code>中，然后再用邮件发送给用户的。</p>
<p>因为加密用户<code>id</code>是用户自己的行为，所以我们在<code>user</code>模型中我们定义一个方法<code>generate_token</code>方法来加密。</p>
<p><code>token</code>必须具备两个最基本的功能：</p>
<ul>
<li>记录用户的<code>id</code>号<br>也就是说我们可以在<code>token</code>中加入一些我们想加入的信息</li>
<li>必须是经过加密和编码<br>不能以明文的形式将用户的信息存放在<code>token</code>中</li>
</ul>
<p>另外一般情况下我们需要对<code>token</code>加上有效时间，所以我们在<code>generate_token</code>方法中传入时间参数<code>expiration</code>，<code>expiration</code>的单位是秒。</p>
<p><code>flask</code>提供了一个非常好用的库叫做<code>itsdangerous</code>，我们可以从<code>itsdangerous</code>导入一些对象来完成以上两个功能。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> TimedJSONWebSignatureSerializer <span class="keyword">as</span> Serializer</span><br></pre></td></tr></table></figure>

<p>类名太长了，所以使用<code>as</code>别名，为了方便使用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> TimedJSONWebSignatureSerializer <span class="keyword">as</span> Serializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">UserMixin, Base</span>):</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_token</span>(<span class="params">self, expiration=<span class="number">600</span></span>):</span></span><br><span class="line">        s = Serializer(current_app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>], expiration)</span><br><span class="line">        tem = s.dumps(&#123;<span class="string">&#x27;id&#x27;</span>: self.<span class="built_in">id</span>&#125;)</span><br><span class="line">        <span class="keyword">return</span> tem</span><br></pre></td></tr></table></figure>

<p>导入<code>Serializer</code>类之后，我们首先要将其实例化，接下来要考虑的是传入什么参数。<code>Serializer</code>可以理解成为一个序列化器。</p>
<ul>
<li>第一个参数要求我们传入一个<strong>几乎是独一无二的随机字符串</strong>，刚好我们之前已经在<code>secure</code>配置文件中定义过了<code>SECRET_KEY</code>也是一个<strong>独一无二的随机字符串</strong>，我们直接将<code>SECRET_KEY</code>当做第一个参数传入进来就可以了。</li>
<li>第二个参数传入一个有效时间，所以将<code>expiration</code>传入进来就可以了。</li>
</ul>
<p>实例化一个序列化器之后，我们就需要把用户的信息写入到序列化器中，写入的方法是调用<code>dumps()</code>方法，这个<code>dumps()</code>接收一个字典，我们将字典的键设置为<code>id</code>,字典的值设置为当前用户的<code>id</code>号，因为我们是在实例方法中编写代码的，所以我们直接使用<code>self.id</code>就可以拿到<code>id</code>号了。</p>
<p>我们在使用断点调试之后可以看到这个<code>tem</code>是在字符串前面带了一个小写的<code>b</code>，说明这个<code>tem</code>是一个<code>byte</code>类型的（是字节码，不是字符串），那么我们要想办法将<code>byte</code>类型的转化为字符串。</p>
<ul>
<li>怎么将<code>byte</code>转化为字符串类型呢？<br>很简单，调用<code>decode()</code>并且制定字符串的格式为<code>utf-8</code>，这样我们就可以得到一个普通的字符串。</li>
</ul>
<p><img src="https://klause-blog-pictures.oss-cn-shanghai.aliyuncs.com/2019-05-14-144201.jpg" alt="image-20180916163314704"></p>
<p>使用<code>decode()</code>之后返回的字符串就是我们最终的<code>token</code>。最终代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> TimedJSONWebSignatureSerializer <span class="keyword">as</span> Serializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">UserMixin, Base</span>):</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_token</span>(<span class="params">self, expiration=<span class="number">600</span></span>):</span></span><br><span class="line">        s = Serializer(current_app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>], expiration)</span><br><span class="line">        <span class="keyword">return</span> s.dumps(&#123;<span class="string">&#x27;id&#x27;</span>: self.<span class="built_in">id</span>&#125;).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br></pre></td></tr></table></figure>



<blockquote>
<p>七月心语：</p>
<p>我们可以在<code>token</code>里面传入任何我们想传入的信息，并不只是用户<code>id</code>，要学会举一反三。</p>
</blockquote>
<h5 id="重置密码"><a href="#重置密码" class="headerlink" title="重置密码"></a>重置密码</h5><p>用户的新密码在前面已经可以传递进来了，新密码传进来之后我们需要为用户更新密码。我们可以在<code>user</code>模型下新建一个<code>reset_password</code>方法来更新用户密码：</p>
<ul>
<li>显然该方法需要接收新密码作为参数。</li>
<li>显然该方法还需要知道这个新密码是属于哪个用户的，所以需要接收<code>token</code>作为参数，通过读取<code>token</code>里的信息是可以拿到用户<code>id</code>的。</li>
</ul>
<p><code>reset_password</code>里的第一件事情就是去读取用户<code>id</code>号，同样要实例化一个<code>Serializer</code>序列化器，同样传入<code>SECRET_KEY</code>。读取<code>token</code>里的信息需要使用<code>loads()</code>方法，需要传入<code>token</code>作为参数，因为之前使用<code>decode()</code>将序列化器返回的内容转化为字符串了，现在进行解码的之前我们同样要先将字符串转化为<code>byte</code>类型（字节码），这里使用<code>encoed(&#39;utf-8&#39;)</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">UserMixin, Base</span>):</span></span><br><span class="line">    ...</span><br><span class="line"><span class="meta">	@staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reset_password</span>(<span class="params">token, new_password</span>):</span></span><br><span class="line">        s = Serializer(current_app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>])</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = s.loads(token.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        uid = data.get(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> db.auto_commit():</span><br><span class="line">            user = User.query.get(uid)</span><br><span class="line">            user.password = new_password</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<p>序列化器解码之后返回结果我们赋值给<code>data</code>，因为我们之前将用户<code>id</code>以字典的形式传入进去的，所以我们解码出来<code>data</code>就是一个字典，在字典中获取值使用<code>data.get(&#39;id’)</code>，<code>id</code>为字典的键。</p>
<blockquote>
<p> 这里我们需要讨论<code>token</code>的安全性：</p>
<p>如果有其他人拿到了<code>token</code>，他有可能读取用户的信息吗?</p>
<p>基本上是不太可能的，因为我们在写入用户信息的时候时使用了<strong>独一无二的字符串</strong>（<code>SECRET_KEY</code>）的，别人拿到<code>token</code>，没有 <code>SECRET_KEY</code>是无法解密的。</p>
</blockquote>
<p>下面有两种情况是我们需要考虑的：</p>
<ul>
<li><code>token</code>确实是由我们的网站生成的，但是它过期了</li>
<li><code>token</code>不是我们网站生成的，而是别人伪造的</li>
</ul>
<p>出现以上两种情况说明<code>token</code>是非法的，当这种情况出现的时候，在调用<code>loads()</code>方法解密的时候会报出异常。既然会报出异常，那么我们可以使用<code>try except</code>来检测下，</p>
<ul>
<li>如果抛出异常我们返回<code>False</code>表明用户重置密码失败；</li>
<li>如果不抛出异常的话我们接着业务流程更新用户密码，最后返回<code>True</code>，表明用户重置密码成功。</li>
</ul>
<p>这里我们使用<code>User.query.get(uid)</code>来查询用户，因为我们使用的是<code>user</code>模型的主键用户``id<code>来查询的，那么我们可以直接使用更加快速的</code>get()<code>方法来查，当然你要使用</code>filter_by()`也没问题。</p>
<blockquote>
<p><code>get()</code>是一种简化的查询形式，当你的查询条件是<strong>模型主键</strong>的时候可以<code>get()</code>查询。</p>
</blockquote>
<blockquote>
<p>七月心语：</p>
<p>对于<code>User</code>的查询，最好加上判空操作，这样更为严谨。</p>
</blockquote>
<p>前面阶段已经完成了用户重置密码方法的编写，接下来需要在视图函数内调用该方法，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@web.route(<span class="params"><span class="string">&#x27;/reset/password/&lt;token&gt;&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">forget_password</span>(<span class="params">token</span>):</span></span><br><span class="line">    form = ResetPasswordForm(request.form)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span> <span class="keyword">and</span> form.validate():</span><br><span class="line">        success = User.reset_password(token, form.password1.data)</span><br><span class="line">        <span class="keyword">if</span> success:</span><br><span class="line">            flash(<span class="string">&#x27;密码重置成功，请使用新密码登录&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;web.login&#x27;</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            flash(<span class="string">&#x27;密码重置失败&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;auth/forget_password.html&#x27;</span>, form=form)</span><br></pre></td></tr></table></figure>





<h5 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h5><p>重置密码页面的<code>forget_password</code>视图函数已经写完了，那么就需要测试一下。我们来回顾一下整个流程，<code>forget_password</code>视图函数是使用<code>token</code>的链接调用的，<code>token</code>的链接是由忘记密码页面的<code>forget_password_request</code>视图函数生成的，如果需要测试<code>forget_password</code>视图函数的话得先走一遍<code>forget_password_request</code>视图函数的流程才能进行测试。</p>
<p><img src="https://klause-blog-pictures.oss-cn-shanghai.aliyuncs.com/2019-05-14-144204.jpg" alt="image-20180916182409920"></p>
<p>这个流程这么长，走一遍勉强还可以接受，但是实际写代码的时候可能经常需要调试，换句话说这个流程我们可能要走很多遍，这是一个相当烦人的事情。更何况我们现在面对的这个业务逻辑是我们非常熟悉的重置用户密码的业务逻辑，这个业务逻辑比较简单只有两个视图函数，但是在大型的项目中一个业务逻辑可能涉及到十几个视图函数的调用流程，那么假如我们为了测试最后几个视图函数，却不得不把前面每个视图函数都走一遍，那这种调试的情况就非常的烦人。</p>
<p>那么有什么方法可以解决这个问题呢？</p>
<p><strong>单元测试</strong>可以帮我们解决这个问题。</p>
<p><strong>单元测试</strong>的优点：</p>
<ul>
<li>可以确保视图函数的正确性，甚至更小粒度函数的正确性</li>
<li>可以解决测试流程过于冗长的问题<br>通过编写单元测试的测试用例是可以伪造一些数据，直接测试第二个视图函数<code>forget_password</code>。</li>
</ul>
<blockquote>
<p>单元测试的国内外背景：</p>
<ul>
<li>国内：很多敏捷开发或者传统开发基本上都是不做单元测试的</li>
<li>国外：很多的软件开发中，单元测试是必备的环节和流程</li>
</ul>
</blockquote>
<h5 id="异步发送电子邮件"><a href="#异步发送电子邮件" class="headerlink" title="异步发送电子邮件"></a>异步发送电子邮件</h5><p>点击忘记密码进入输入邮箱页面：</p>
<ul>
<li><p>细节1：点击提交邮箱之后，没有任何提示</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flash(<span class="string">&#x27;密码重置邮件已经发送到您的邮箱&#x27;</span> + account_email + <span class="string">&#x27;，请及时查收!&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>闪现一条提示消息，搞定！</p>
</li>
<li><p>细节2：点击提交邮箱之后，没有跳转到其他页面</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;web.login&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>重定向到登录页面，搞定！</p>
</li>
<li><p>细节3：点击提交邮箱之后，发送电子邮件缓慢，页面一直处于加载状态<br>很明显，加载缓慢的原因是由于<code>send_mail</code>引起的，因为发送电子邮件需要连接电子邮件服务器，连接的过程以及发送的时间不是自己能够控制的，有一定的缓慢是非常正常的，因为使用的是第三方的服务器（腾讯的电子邮箱服务器）。</p>
</li>
</ul>
<p>需要考虑的是：</p>
<p>我们提交邮箱之后需要把邮件<strong>实时</strong>的发送到用户邮箱吗？实际上并不需要那么高的实时性，只需要在几分钟内发送到用户邮箱就可以了。我们页面之所以出现停顿的原因就在于等<code>send_mail</code>整个函数走完之后才能最终<code>return</code>结束掉这次视图函数的访问。如果说<code>send_mail</code>时间非常长的话，那么你的页面就会一直处于停顿的状态。</p>
<p>既然<code>send_mail</code>不需要这么高的实时性，那么可以将<code>send_mail</code>放到另外的线程中<strong>异步发送电子邮件</strong>。</p>
<p>我们先定义一个异步函数<code>send_async_email</code>，然后在<code>send_mail</code>函数的主线程中启动一个新的线程<code>Thread</code>，它的目标就是新定义的异步函数<code>send_async_email</code>，使用<code>args=[]</code>将异步函数需要的参数传入进去。</p>
<p><img src="https://klause-blog-pictures.oss-cn-shanghai.aliyuncs.com/2019-05-14-144207.jpg" alt="image-20180916211015952"></p>
<p>异常：<code>Working outside of application context</code></p>
<p>应该很熟悉，解决方案是显而易见的，我们需要手动的把上下文管理器<code>app_context</code>推入栈中就行了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_async_email</span>(<span class="params">app, msg</span>):</span></span><br><span class="line">    <span class="keyword">with</span> app.app_context():</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            mail.send(msg)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>以上代码可以解决<code>app_context</code>的问题。</p>
<p>接下来的问题是<code>app</code>从哪里来？</p>
<p>我们在<code>send_mail</code>是可以访问到<code>flask</code>核心对象<code>app</code>的，所以需要将<code>flask</code>核心对象<code>app</code>传入到异步函数<code>send_async_email</code>里面去。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_async_email</span>(<span class="params">app, msg</span>):</span></span><br><span class="line">    <span class="keyword">with</span> app.app_context():</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            mail.send(msg)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_email</span>(<span class="params">to, subject, template, **kwargs</span>):</span></span><br><span class="line">    msg = Message(<span class="string">&#x27;鱼书&#x27;</span>+<span class="string">&#x27;&#x27;</span>+ subject,</span><br><span class="line">                  sender=current_app.config[<span class="string">&#x27;MAIL_USERNAME&#x27;</span>],</span><br><span class="line">                  recipients=[to])</span><br><span class="line">    msg.html = render_template(template, **kwargs)</span><br><span class="line">    thr = Thread(target=send_async_email, args=[current_app, msg])</span><br><span class="line">    thr.start()</span><br></pre></td></tr></table></figure>

<p>我们用以上代码进行断点调试。</p>
<p><img src="https://klause-blog-pictures.oss-cn-shanghai.aliyuncs.com/2019-05-14-144209.jpg" alt="image-20180916212333635"></p>
<p><img src="https://klause-blog-pictures.oss-cn-shanghai.aliyuncs.com/2019-05-14-144212.jpg" alt="image-20180916212648728"></p>
<p>我们看到调试结果，在<code>send_mail</code>中运行的时候<code>current_app</code>是有值的<code>&lt;Flask &#39;app&#39;&gt;</code>，但是在异步线程里，确是<code>unbound</code>无值的。</p>
<p>这里考察到两个知识点：</p>
<ul>
<li>是否真正理解<code>current_app</code></li>
<li>是否真正理解线程隔离</li>
</ul>
<p>关于<code>current_app</code>，很多同学就把它直接<strong>等同于</strong><code>flask</code>核心对象<code>app</code>，也就是说很多同学认为<code>current_app</code>和实例化的<code>flask</code>核心对象<code>app</code>是一摸一样的，实际上<strong>是不一样的</strong>！！</p>
<p><code>current_app</code>是一个<strong>代理对象</strong><code>LocalProxy</code>。</p>
<ul>
<li>我们实例化一个<code>flask</code>核心对象<code>app</code>，把它赋值给一个变量<code>app</code>，那么**无论你在任何地方引用这个<code>app</code>，它永远都是<code>flask</code>核心对象<code>app</code>**；</li>
<li><code>current_app</code>的机制不一样，每次访问<code>current_app</code>变量的时候都会去<code>_app_ctx_stack</code>栈中读取栈顶元素，强调的是<strong>每一次去读取<code>current_app</code>的时候</strong>。我们在<code>send_mail</code>中访问了<code>current_app</code>，在异步函数<code>send_async_email</code>中我们又一次去访问了<code>current_app</code>，这两次访问<code>current_app</code>，可能又一次栈顶是有元素的，可能另外一次栈顶是没有元素的。比如我们在<code>send_mail</code>中访问<code>current_app</code>的时候栈顶就是有元素的，而我们在异步函数<code>send_async_email</code>中访问<code>current_app</code>的时候栈顶是没有元素的，这就导致了会出现<code>unbound</code>的状态。</li>
</ul>
<p>但是如果我们在<code>send_mail</code>里直接实例化一个<code>flask</code>核心对象<code>app</code>，将它赋值给一个<code>app</code>变量，再将这个<code>app</code>变量传入异步函数<code>send_async_email</code>就不会出现<code>unbound</code>的情况。因为这时，任何情况下访问该<code>app</code>变量永远都是指向一个确定存在的<code>flask</code>核心对象的。</p>
<p>进一步揭示为什么在<code>send_mail</code>中访问<code>current_app</code>代理对象是有值的，而在异步函数<code>send_async_email</code>中访问<code>current_app</code>代理对象是无值的？</p>
<p>这两个函数最大的区别在于<code>send_async_email</code>启动了一个新的线程，说到线程就很容易想到<code>LocalStack</code>，也就是说<code>send_mail</code>中的线程<code>id</code>号与<code>send_async_email</code>线程<code>id</code>号是不同的。</p>
<p>更加准确的说，由于线程隔离，</p>
<ul>
<li>在<code>send_mail</code>中：<code>current_app</code>一定是有值的</li>
<li>在<code>send_async_email</code>中：<code>current_app</code>一定是无值的</li>
</ul>
<p><img src="https://klause-blog-pictures.oss-cn-shanghai.aliyuncs.com/2019-05-14-144214.jpg" alt="image-20180916213828981"></p>
<p>因为<code>send_mail</code>是在视图函数中调用的，调用视图函数的话，一定是有一个请求进来。请求进来之后<code>Request Context</code>要入栈，入栈之前<code>flask</code>会去检测一下另外的一个栈<code>_app_ctx_stack</code>中有没有<code>AppContext</code>，如果没有的话，<code>flask</code>框架会负责把<code>AppContext</code>自动推入到<code>_app_ctx_stack</code>栈中去，所以说当<code>current_app</code>来访问<code>_app_ctx_stack</code>的栈顶元素的时候一定是有值的。但是如果你重组线程，启动了一个新的线程，在新的线程里由于线程隔离的作用，这些栈都是空的，又没有人或者说没有代码帮助你把<code>AppContext</code>推入栈中，所以说你用<code>current_app</code>引用栈顶元素的时候一定会得到一个<code>unbound</code>的在状态。</p>
<p>问题的关键在于我们从<code>send_mail</code>中往<code>send_async_email</code>中传入的是一个代理对象，不是一个真实的<code>flask</code>核心对象，代理对象去查找<code>flask</code>核心对象的时候是需要根据线程的<code>id</code>号查找的，由于我们改变了线程的<code>id</code>号，<code>current_app</code>在另外的线程中就找不到<strong>真实的<code>flask</code>核心对象</strong>。</p>
<p>那么我们换一种思路，直接在<code>send_mail</code>中取到<strong>真实的<code>flask</code>核心对象</strong>，并且把<code>flask</code>真实的核心对象当做参数传入<code>send_async_email</code>中去就可以了。</p>
<p><strong>真实的<code>flask</code>核心对象</strong>在任何线程中都是存在的，<strong>代理对象</strong>是受到线程<code>id</code>影响的，因为代理对象本身就具有线程隔离的属性。</p>
<p>那么接下来的问题就是如何在<code>send_mail</code>中拿到<strong>真实的<code>flask</code>核心对象</strong>？</p>
<p>使用<code>current_app</code>的<code>_get_current_object</code>方法，代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app = current_app._get_current_object()</span><br></pre></td></tr></table></figure>




<blockquote>
<p>七月心语：</p>
<p>异步编程并不是大家想的那么简单的，它会引起各种各样的问题，比如上面遇到的问题，如果说你不熟悉异步编程，你也不了解<code>flask</code>核心机制的话，就很难解决这个问题。而且这只是发送一个电子邮件，业务逻辑极其简单，都会有这么困哪的问题要解决，可想而知，在复杂的项目中用异步编程是多谋头疼。所以说我的原则就是，如果你对性能要求不高，建议都是用同步编程，如果确实对性能要求高的话，首先应该是先考虑各种各样的优化，实在是优化到极限之后再考虑<strong>异步编程</strong>。</p>
<p>建议大家不要忙不的追求并发和异步编程，绝大多数的同学做很多的项目其实都用不到并发和异步编程，你首先应该考虑的是在同步的情况下能否很好的进行优化，实在优化不了再去考虑并发处理和异步编程。</p>
</blockquote>
<h5 id="异步线程参数传递的方法"><a href="#异步线程参数传递的方法" class="headerlink" title="异步线程参数传递的方法"></a>异步线程参数传递的方法</h5><p> 如果我们想向另一个线程里的目标函数传递参数的话，传递的方法就是在<code>Thread</code>构造的时候加上一个关键字参数<code>args=[]</code>，<code>args=[]</code>是可以接收一组参数的列表。</p>
<h3 id="鱼漂业务逻辑与Drift模型"><a href="#鱼漂业务逻辑与Drift模型" class="headerlink" title="鱼漂业务逻辑与Drift模型"></a>鱼漂业务逻辑与Drift模型</h3><p><img src="https://klause-blog-pictures.oss-cn-shanghai.aliyuncs.com/2019-05-14-144216.jpg" alt="image-20180917081640160"></p>
<p>实际上鱼漂急速一个交易的过程，交易过程中的信息基本有请求者信息、赠送者信息、书籍信息、邮寄信息四大类。</p>
<p>我们在<code>models</code>层新建<code>drift</code>文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String, ForeignKey</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> relationship</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> app.models.base <span class="keyword">import</span> Base</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Drift</span>(<span class="params">Base</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 请求者信息</span></span><br><span class="line">    requester_id = Column(Integer)</span><br><span class="line">    requester_nickname = Column(String(<span class="number">20</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 赠送者信息</span></span><br><span class="line">    gifter_id = Column(Integer)</span><br><span class="line">    gift_id = Column(Integer)</span><br><span class="line">    gifter_nickname = Column(String(<span class="number">20</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 书籍信息</span></span><br><span class="line">    isbn = Column(String(<span class="number">13</span>))</span><br><span class="line">    book_title = Column(String(<span class="number">50</span>))</span><br><span class="line">    book_author = Column(String(<span class="number">50</span>))</span><br><span class="line">    book_img = Column(String(<span class="number">50</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 邮寄信息</span></span><br><span class="line">    recipient_name = Column(String(<span class="number">20</span>), nullable=<span class="literal">True</span>)</span><br><span class="line">    address = Column(String(<span class="number">100</span>), nullable=<span class="literal">True</span>)</span><br><span class="line">    mobile = Column(String(<span class="number">20</span>), nullable=<span class="literal">True</span>)</span><br><span class="line">    message = Column(String(<span class="number">200</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># requester_id = Column(Integer, ForeignKey(&#x27;user.id&#x27;))</span></span><br><span class="line">    <span class="comment"># requester = relationship(&#x27;User&#x27;)</span></span><br><span class="line">    <span class="comment"># gift_id = Column(Integer, ForeignKey(&#x27;gift.id&#x27;))</span></span><br><span class="line">    <span class="comment"># gift = relationship(&#x27;Gift&#x27;)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h4 id="利用数据冗余记录历史状态"><a href="#利用数据冗余记录历史状态" class="headerlink" title="利用数据冗余记录历史状态"></a>利用<strong>数据冗余</strong>记录历史状态</h4><p><code>Drift</code>所有内容都是平铺的，并没有出现模型关联，为什么要这样设计？这样设计有什么好处？</p>
<ul>
<li>模型关联<ul>
<li>优点：每次查询时，关联模型的信息都是最新的</li>
<li>缺点：没有忠实记录交易状态信息</li>
<li>缺点：关联查询需要查询多张表，查询速度较慢</li>
<li>缺点：耗费大量数据库资源</li>
</ul>
</li>
<li>模型不关联<ul>
<li>优点：查询次数少</li>
<li>优点：忠实记录了交易状态，保证历史信息不变</li>
<li>缺点：数据冗余</li>
<li>缺点：可能导致数据的不一致</li>
</ul>
</li>
</ul>
<p><code>Drift</code>模型是用来记录交易的，记录的是历史交易状态，一般对于具有记录性质的字段，不使用模型关联。比如日志的记录，也是直接记录不使用模型关联。</p>
<h4 id="设计交易状态"><a href="#设计交易状态" class="headerlink" title="设计交易状态"></a>设计交易状态</h4><p><code>Drift</code>里如何设计表示交易状态的信息？</p>
<p>对于状态而言，最好的解决方法是枚举类型。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PendingStatus</span>(<span class="params">Enum</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    交易的4种状态</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    Waiting = <span class="number">1</span></span><br><span class="line">    Success = <span class="number">2</span></span><br><span class="line">    Reject = <span class="number">3</span></span><br><span class="line">    Redraw = <span class="number">4</span></span><br></pre></td></tr></table></figure>

<p>枚举的调用：</p>
<p>在<code>Drift</code>模型中搜索当前用户已经成功索要到的书籍数量。判定条件：</p>
<ul>
<li>用户为当前用户</li>
<li>成功索要到<br>成功就是表明<code>Drift</code>模型的状态，这里使用枚举<code>PendingStatus.Success</code>，直接可以从英文字面意思看出鱼漂的状态，完美<code>coding</code>！</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">success_receive_count = Drift.query.filter_by(requester_id=self.<span class="built_in">id</span>, pending=PendingStatus.Success).count()</span><br></pre></td></tr></table></figure>





<blockquote>
<p><code>first_or_404()</code>对应的是<code>first()</code></p>
<p><code>get_or_404()</code>对应的是<code>get()</code></p>
<p>二者用法相同。</p>
</blockquote>
<h4 id="检测能否发起交易"><a href="#检测能否发起交易" class="headerlink" title="检测能否发起交易"></a>检测能否发起交易</h4><ul>
<li><p>自己不能向自己索要书籍</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_yourself_gift</span>(<span class="params">self, uid</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span> <span class="keyword">if</span> self.uid == uid <span class="keyword">else</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>鱼豆的必须足够（大于1）</p>
</li>
<li><p>每索取两本书，自己必须送出一本书</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">can_send_drift</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">if</span> self.beans &lt; <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    success_gifts_count = Gift.query.filter_by(</span><br><span class="line">        uid=self.<span class="built_in">id</span>, launched=<span class="literal">True</span>).count()</span><br><span class="line">    success_receive_count = Drift.query.filter_by(</span><br><span class="line">        requester_id=self.<span class="built_in">id</span>, pending=PendingStatus.Success).count()</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span> <span class="keyword">if</span> floor(success_gifts_count / <span class="number">2</span>) &lt;= success_receive_count <span class="keyword">else</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>


</li>
</ul>
<blockquote>
<p>小技巧：</p>
<p>从数据库里查出来的原始数据，需要用一个<code>ViewModel</code>将其适配为页面需要的数据形式。</p>
</blockquote>
<blockquote>
<p><strong>知识点</strong>：</p>
<p><code>wtforms</code>所有的<code>Form</code>对象提供了一个快捷的方法，可以帮助我们直接把<code>Form</code>下面所有的字段拷贝到<code>Drift</code>模型中来，只需要调用<code>Form</code>对象的<code>populate_obj</code>方法，并且将我们要复制的目标对象传入到参数列表中，就可以实现相关字段的复制了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drift_form.populate_obj(drift)</span><br></pre></td></tr></table></figure>

<p>注意：使用<code>populate_obj</code>的话，必须要确保两个对象中定义的字段名称是相同的。（当前示例中<code>Drift</code>模型和表单的字段名字一致，可以使用）</p>
</blockquote>
<h4 id="数据库或关系查询"><a href="#数据库或关系查询" class="headerlink" title="数据库或关系查询"></a>数据库<strong>或</strong>关系查询</h4><p>查询数据库中赠送者<strong>或</strong>索要者为当前页用户的<code>Drift</code>：</p>
<p>一般情况我们很自然的会像下面这样写，但是实际上这样是错误的，这样写依旧是<strong>且</strong>关系查询，一个结果都查不到。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">drift = Drift.query.filter_by(requester_id == current_user.<span class="built_in">id</span>, gifter_id == current_user.<span class="built_in">id</span>)).order_by(</span><br><span class="line">        desc(Drift.create_time)).<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>

<p>解决方案</p>
<ul>
<li><code>first</code>方法</li>
<li><code>sqlalchemy</code>的<code>or_</code>方法，将条件传入<br>注意：<code>requester_id</code>和<code>gifter_id</code>前面都需要加上模型名称，并且使用<code>==</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> or_, desc</span><br><span class="line"></span><br><span class="line">drift = Drift.query.<span class="built_in">filter</span>(or_(</span><br><span class="line">        Drift.requester_id == current_user.<span class="built_in">id</span>,</span><br><span class="line">        Drift.gifter_id == current_user.<span class="built_in">id</span>)).order_by(</span><br><span class="line">        desc(Drift.create_time)).<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>





<h4 id="构建DriftViewModel"><a href="#构建DriftViewModel" class="headerlink" title="构建DriftViewModel"></a>构建<code>DriftViewModel</code></h4><p>模型里的字段都是要在页面显示出来的字段。</p>
<p>难点：需要根据数据的状态调整对应的值。</p>
<p><img src="https://klause-blog-pictures.oss-cn-shanghai.aliyuncs.com/2019-05-14-144220.jpg" alt="image-20180919161603860"></p>
<p>解决方案：</p>
<ul>
<li>将不同状态分类，分别显示在两栏</li>
<li>显示在一栏，代码复杂，需要做逻辑判断，可以在前端做也可以在后端做好再返回数据</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> app.libs.enums <span class="keyword">import</span> PendingStatus</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DriftViewModel</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, drift, current_user_id</span>):</span></span><br><span class="line">        self.data = &#123;&#125;</span><br><span class="line">        self.__parse(drift, current_user_id)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__parse</span>(<span class="params">self, drift, current_user_id</span>):</span></span><br><span class="line">        <span class="comment"># 确定当前用户是请求者还是赠送者</span></span><br><span class="line">        you_are = self.requester_or_gifter(drift, current_user_id)</span><br><span class="line">        pending_status = PendingStatus.pending_str(drift.pending, you_are)</span><br><span class="line"></span><br><span class="line">        r = &#123;</span><br><span class="line">            <span class="comment"># 当前用户信息</span></span><br><span class="line">            <span class="string">&#x27;you_are&#x27;</span>: you_are,</span><br><span class="line">            <span class="string">&#x27;operator&#x27;</span>: drift.requester_nickname <span class="keyword">if</span> you_are != <span class="string">&#x27;requester&#x27;</span> <span class="keyword">else</span> drift.gifter_nickname,</span><br><span class="line">            <span class="string">&#x27;status_str&#x27;</span>: pending_status,</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 鱼漂信息</span></span><br><span class="line">            <span class="string">&#x27;drift_id&#x27;</span>: drift.<span class="built_in">id</span>,</span><br><span class="line">            <span class="string">&#x27;date&#x27;</span>: drift.create_datetime.strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>),</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 书籍信息</span></span><br><span class="line">            <span class="string">&#x27;book_title&#x27;</span>: drift.book_title,</span><br><span class="line">            <span class="string">&#x27;book_author&#x27;</span>: drift.book_author,</span><br><span class="line">            <span class="string">&#x27;book_img&#x27;</span>: drift.book_img,</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 收件人信息</span></span><br><span class="line">            <span class="string">&#x27;recipient_name&#x27;</span>: drift.requester_nickname,</span><br><span class="line">            <span class="string">&#x27;mobile&#x27;</span>: drift.mobile,</span><br><span class="line">            <span class="string">&#x27;address&#x27;</span>: drift.message,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: drift.message,</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 交易信息</span></span><br><span class="line">            <span class="string">&#x27;status&#x27;</span>: drift.pending</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">requester_or_gifter</span>(<span class="params">drift, current_user_id</span>):</span></span><br><span class="line">        <span class="keyword">if</span> drift.requester_id == current_user_id:</span><br><span class="line">            you_are = <span class="string">&#x27;requester&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            you_are = <span class="string">&#x27;gifter&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> you_are</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>Drift</code>创建时间需要做转换，数据库里的时间戳转换为页面显示的时间：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;date&#x27;</span>: drift.create_datetime.strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>判断当前用户是谁：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">you_are = self.requester_or_gifter(drift, current_user_id)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;operator&#x27;</span>: drift.requester_nickname <span class="keyword">if</span> you_are != <span class="string">&#x27;requester&#x27;</span> <span class="keyword">else</span> drift.gifter_nickname,</span><br></pre></td></tr></table></figure>

<p>对于需要判断的状态：</p>
<ul>
<li>可以传到前端判断</li>
<li>也可以在后端判断好再传数据</li>
</ul>
<blockquote>
<p>小技巧：</p>
<p>在判断当前用户的时候需要使用到<strong>当前用户id</strong>，我们可以在导入<strong>当前用户id</strong><code>current_user.id</code>，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> drift.requester_id == current_user.<span class="built_in">id</span>:</span><br></pre></td></tr></table></figure>

<p>这样写是可以的，但是不推荐这样写，不建议在<code>ViewModel</code>中使用<code>current_user</code>。</p>
<p><strong>因为</strong>这是一个<strong>面向对象类设计</strong>的原则，<code>current_user</code>直接导入进来会破坏类的封装性，会让<code>DriftViewModel</code>类与<code>current_user</code>形成非常紧密的耦合，会让<code>DriftViewModel</code>永远离不开<code>current_user</code>，也就是说你在使用<code>DriftViewModel</code>的地方都必须导入<code>current_user</code>，这是非常尴尬的事情，所以我们就不能将<code>DriftViewModel</code>用在一个没有<code>current_user</code>的环境里。</p>
<p><strong>所以不能让对象从类里凭空蹦出来，我们可以使用传递参数的形式将需要的内容传递进来，这样就能确保类具有良好的封装性（保证了类的独立性，也增强了类的灵活性）。</strong></p>
</blockquote>
</li>
<li><p>添加鱼漂的状态属性：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PendingStatus</span>(<span class="params">Enum</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    交易的4种状态</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    Waiting = <span class="number">1</span></span><br><span class="line">    Success = <span class="number">2</span></span><br><span class="line">    Reject = <span class="number">3</span></span><br><span class="line">    Redraw = <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pending_str</span>(<span class="params">cls, status, key</span>):</span></span><br><span class="line">        key_map = &#123;</span><br><span class="line">            <span class="number">1</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;requester&#x27;</span>: <span class="string">&#x27;等待对方邮件&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;gifter&#x27;</span>: <span class="string">&#x27;等待您邮寄&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="number">2</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;requester&#x27;</span>: <span class="string">&#x27;对方已邮寄&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;gifter&#x27;</span>: <span class="string">&#x27;您已邮寄&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="number">3</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;requester&#x27;</span>: <span class="string">&#x27;对方已拒绝&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;gifter&#x27;</span>: <span class="string">&#x27;您已拒绝&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="number">4</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;requester&#x27;</span>: <span class="string">&#x27;对方已撤销&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;gifter&#x27;</span>: <span class="string">&#x27;您已撤销&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> key_map[status][key]</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">pending_status = PendingStatus.pending_str(drift.pending, you_are)	<span class="comment"># 定义</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;status_str&#x27;</span>: pending_status	<span class="comment"># 调用</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>Python</code>是没有<code>switch case</code>语句的，如果要模仿<code>switch case</code>的话，可以使用<strong>双层字典</strong>的方式来模拟。示例如上代码。</p>
</blockquote>
</li>
</ul>
<h4 id="三种类模式的总结与对比"><a href="#三种类模式的总结与对比" class="headerlink" title="三种类模式的总结与对比"></a>三种类模式的总结与对比</h4><p>对比总结三种<code>ViewModel</code>：<code>BookViewModel</code>、<code>MyGifts</code>、<code>DriftViewModel</code>，这三种<code>ViewModel</code>各有自己的特色。</p>
<ul>
<li><p>共同特点：</p>
<ul>
<li><p>既有单体，也有集合</p>
<blockquote>
<p>七月心语：</p>
<p>根据多年的经验，这不是一个特例，几乎在写任何业务项目的时候，都是要面临单体和集合的概念的。</p>
<p>建议：单体、集合做区分。单体是单体，集合是集合。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<ol>
<li><p><code>BookViewModel</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookViewModel</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, book</span>):</span></span><br><span class="line">        self.title = book[<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">        self.publisher = book[<span class="string">&#x27;publisher&#x27;</span>]</span><br><span class="line">        self.author = <span class="string">&#x27;丶&#x27;</span>.join(book[<span class="string">&#x27;author&#x27;</span>])</span><br><span class="line">        self.pages = book[<span class="string">&#x27;pages&#x27;</span>] <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">        self.price = book[<span class="string">&#x27;price&#x27;</span>]</span><br><span class="line">        self.summary = book[<span class="string">&#x27;summary&#x27;</span>] <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">        self.image = book[<span class="string">&#x27;image&#x27;</span>]</span><br><span class="line">        self.isbn = book[<span class="string">&#x27;isbn&#x27;</span>]</span><br><span class="line">        self.pubdate = book[<span class="string">&#x27;pubdate&#x27;</span>]</span><br><span class="line">        self.binding = book[<span class="string">&#x27;binding&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">intro</span>(<span class="params">self</span>):</span></span><br><span class="line">        intros = <span class="built_in">filter</span>(<span class="keyword">lambda</span> x: <span class="literal">True</span> <span class="keyword">if</span> x <span class="keyword">else</span> <span class="literal">False</span>,</span><br><span class="line">                        [self.author, self.publisher, self.price])</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27; / &#x27;</span>.join(intros)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookCollection</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.total = <span class="number">0</span></span><br><span class="line">        self.books = []</span><br><span class="line">        self.keyword = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fill</span>(<span class="params">self, yushu_book, keyword</span>):</span></span><br><span class="line">        self.total = yushu_book.total</span><br><span class="line">        self.books = [BookViewModel(book) <span class="keyword">for</span> book <span class="keyword">in</span> yushu_book.books]</span><br><span class="line">        self.keyword = keyword</span><br></pre></td></tr></table></figure>

<p>单本的<code>BookViewModel</code>和书籍集合的<code>BookConnection</code>是最典型的、最基础的<code>ViewModel</code>的构建方式。我们是把<code>BookViewModel</code>当做一个非常标准的类来处理的，它拥有他的实例属性。</p>
<ul>
<li>优点：具有良好的扩展性</li>
</ul>
</li>
<li><p><code>MyGifts</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> app.view_models.book <span class="keyword">import</span> BookViewModel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># MyGift = namedtuple(&#x27;MyGift&#x27;, [&#x27;id&#x27;, &#x27;book&#x27;, &#x27;wishes_count&#x27;])</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyGifts</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, gifts_of_mine, wish_count_list</span>):</span></span><br><span class="line">        self.gifts = []</span><br><span class="line"></span><br><span class="line">        self.__gifts_of_mine = gifts_of_mine</span><br><span class="line">        self.__wish_count_list = wish_count_list</span><br><span class="line"></span><br><span class="line">        self.gifts = self.__parse()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__parse</span>(<span class="params">self</span>):</span></span><br><span class="line">        tem_gifts = []</span><br><span class="line">        <span class="keyword">for</span> gift <span class="keyword">in</span> self.__gifts_of_mine:</span><br><span class="line">            my_gift = self.__matching(gift)</span><br><span class="line">            tem_gifts.append(my_gift)</span><br><span class="line">        <span class="keyword">return</span> tem_gifts</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__matching</span>(<span class="params">self, gift</span>):</span></span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> wish_count <span class="keyword">in</span> self.__wish_count_list:</span><br><span class="line">            <span class="keyword">if</span> wish_count[<span class="string">&#x27;isbn&#x27;</span>] == gift.isbn:</span><br><span class="line">                count = wish_count[<span class="string">&#x27;count&#x27;</span>]</span><br><span class="line">        r = &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: gift.<span class="built_in">id</span>,</span><br><span class="line">            <span class="string">&#x27;book&#x27;</span>: BookViewModel(gift.book),</span><br><span class="line">            <span class="string">&#x27;wishes_count&#x27;</span>: count</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> r</span><br><span class="line">        <span class="comment"># my_gift = MyGift(gift.id, BookViewModel(gift.book), count)</span></span><br><span class="line">        <span class="comment"># return my_gift</span></span><br></pre></td></tr></table></figure>

<p><code>gift</code>这里只有集合<code>MyGifts</code>，没有单体的<code>ViewModel</code>。为什么会是这样的呢？其实还是有单体概念的，只不过我们没有为单体单独定义一个类对应<strong>单体概念</strong>，而是把<strong>单体</strong>的概念隐藏到<strong>字典</strong>里面去，直接返回了字典。</p>
<p>这种做法的</p>
<ul>
<li><p>优点：字典结构使用方便，少写了一些代码（少定义了一个类）</p>
</li>
<li><p>缺点：扩展性差（没有办法扩展）</p>
<p>业务是多变的，如果未来需要<strong>特别地</strong>处理单体<code>Gift</code>的时候，字典是没有办法扩展的。</p>
</li>
</ul>
</li>
<li><p><code>DriftViewModel</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> app.libs.enums <span class="keyword">import</span> PendingStatus</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理一组鱼漂数据</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DriftConnection</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, drifts, current_user_id</span>):</span></span><br><span class="line">        self.data = []</span><br><span class="line"></span><br><span class="line">        self.__parse(drifts, current_user_id)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__parse</span>(<span class="params">self, drifts, current_user_id</span>):</span></span><br><span class="line">        <span class="keyword">for</span> drift <span class="keyword">in</span> drifts:</span><br><span class="line">            temp = DriftViewModel(drift, current_user_id)</span><br><span class="line">            self.data.append(temp.data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理单个鱼漂数据</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DriftViewModel</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, drift, current_user_id</span>):</span></span><br><span class="line">        self.data = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        self.__parse(drift, current_user_id)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__parse</span>(<span class="params">self, drift, current_user_id</span>):</span></span><br><span class="line">        <span class="comment"># 确定当前用户是请求者还是赠送者</span></span><br><span class="line">        you_are = self.requester_or_gifter(drift, current_user_id)</span><br><span class="line">        pending_status = PendingStatus.pending_str(drift.pending, you_are)</span><br><span class="line"></span><br><span class="line">        r = &#123;</span><br><span class="line">            <span class="comment"># 当前用户信息</span></span><br><span class="line">            <span class="string">&#x27;you_are&#x27;</span>: you_are,</span><br><span class="line">            <span class="string">&#x27;operator&#x27;</span>: drift.requester_nickname <span class="keyword">if</span> you_are != <span class="string">&#x27;requester&#x27;</span> <span class="keyword">else</span> drift.gifter_nickname,</span><br><span class="line">            <span class="string">&#x27;status_str&#x27;</span>: pending_status,</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 鱼漂信息</span></span><br><span class="line">            <span class="string">&#x27;drift_id&#x27;</span>: drift.<span class="built_in">id</span>,</span><br><span class="line">            <span class="string">&#x27;date&#x27;</span>: drift.create_datetime.strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>),</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 书籍信息</span></span><br><span class="line">            <span class="string">&#x27;book_title&#x27;</span>: drift.book_title,</span><br><span class="line">            <span class="string">&#x27;book_author&#x27;</span>: drift.book_author,</span><br><span class="line">            <span class="string">&#x27;book_img&#x27;</span>: drift.book_img,</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 收件人信息</span></span><br><span class="line">            <span class="string">&#x27;recipient_name&#x27;</span>: drift.requester_nickname,</span><br><span class="line">            <span class="string">&#x27;mobile&#x27;</span>: drift.mobile,</span><br><span class="line">            <span class="string">&#x27;address&#x27;</span>: drift.message,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: drift.message,</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 交易信息</span></span><br><span class="line">            <span class="string">&#x27;status&#x27;</span>: drift.pending</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">requester_or_gifter</span>(<span class="params">drift, current_user_id</span>):</span></span><br><span class="line">        <span class="keyword">if</span> drift.requester_id == current_user_id:</span><br><span class="line">            you_are = <span class="string">&#x27;requester&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            you_are = <span class="string">&#x27;gifter&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> you_are</span><br></pre></td></tr></table></figure>

<p><code>DriftViewModel</code>里有一个很典型的特征，没有像在<code>BookViewModel</code>中那样将所有字段全部定义出来，而是使用<code>self.data = &#123;&#125;</code>字典的形式。</p>
<ul>
<li><p>优点：即单独定义了单体的概念，具备良好的扩展性，又具备了字典方便的特性这种形式</p>
</li>
<li><p>缺点：可读性较差</p>
<p>代码维护者不能简洁明了的看出类的属性。</p>
</li>
</ul>
</li>
</ol>
<p>对于以上三种<code>ViewModel</code>推荐使用<code>BookViewModel</code>，不推荐使用<code>MyGifts</code>。</p>
<h4 id="撤销-拒绝鱼漂"><a href="#撤销-拒绝鱼漂" class="headerlink" title="撤销/拒绝鱼漂"></a>撤销/拒绝鱼漂</h4><p>我们在写<code>redraw_drift</code>视图函数的时候，会出现问题（拒绝视图函数<code>reject_drift</code>和撤销操作基本一致）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@web.route(<span class="params"><span class="string">&#x27;/drift/&lt;int:did&gt;/redraw&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">redraw_drift</span>(<span class="params">did</span>):</span></span><br><span class="line">    <span class="keyword">with</span> db.auto_commit():</span><br><span class="line">        drift = Drift.query.filter_by(<span class="built_in">id</span>=did).first_or_404()</span><br><span class="line">        drift.pending = PendingStatus.Redraw</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;web.pending&#x27;</span>))</span><br><span class="line">    <span class="comment"># 这里最好是写成ajax的，来回重定向消耗服务器资源</span></span><br></pre></td></tr></table></figure>

<p>调试之后我们会发现一个非常严重的问题，<code>PendingStatus.Redraw</code>对应的数字是<code>4</code>，但是我们却发现执行了这样一个赋值操作之后，<code>drift.pending</code>的值被赋值成了<code>0</code>，很显然这是不对的。原因在于<strong>枚举</strong>并不真正等同于数字，你把枚举类型直接赋值给数字的<code>drift.pending</code>这是不对的，这个错误是非常致命的。同样我们之前在<code>User</code>模型中使用枚举的用法也是错误的。<img src="https://klause-blog-pictures.oss-cn-shanghai.aliyuncs.com/2019-05-14-144222.jpg" alt="image-20180920093319788"></p>
<p>要解决这个问题，我们总共有三种方案：</p>
<ol>
<li><p>使用<code>PendingStatus.Redraw.value</code><br>这种用法将直接获取<code>Redrew</code>真正所对应的数字</p>
</li>
<li><p>不适用<code>PendingStatus.Redraw</code>，直接使用<code>4</code>为<code>drift.pending</code>赋值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drift.pending = <span class="number">4</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>我们之前还有一个很不好的写法，之前我们在写<code>PendingStatus</code>枚举的时候，我们给它增加了一个<code>pending_str</code>方法，在方法里使用的双层字典，里面是<code>1、2、3、4</code>的数字，感觉非常不好，别人看你代码的时候需要对照着上面的代码理解<code>1、2、3、4</code>表示的状态，不能一眼看出状态。</p>
<p>那怎么解决这个问题呢？<br>我们可以再<code>drift</code>模型里为<code>pending</code>属性添加一个<code>@property</code>定义一个<code>getter</code>方法，首先将<code>pending</code>字段添加下划线，为<code>drift</code>模型添加一个<code>pending</code>属性，这个属性内部是可以写一个逻辑的，这个逻辑就是读取<code>_pending</code>，<code>_pending</code>是<code>SmallInteger</code>类型的（数字），但是我们可以在读取的时候转化成<strong>枚举类型</strong>，<strong>转化的方式就类似于在实例化对象时候的操作方法一样</strong>，把<code>PendingStatus</code>当做是一个对象，然后把<code>self._pending</code>传入到构造函数中去。这里是<strong>类似</strong>，并不代表着这里是构造函数。通过这样操作之后，**<code>drift.pending</code>操作返回的就不是数字类型了，而是枚举类型**。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">_pending = Column(<span class="string">&#x27;pending&#x27;</span>, SmallInteger, default=<span class="number">1</span>)</span><br><span class="line">   </span><br><span class="line"><span class="meta">@property</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pending</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">return</span> PendingStatus(self.pending)</span><br><span class="line"><span class="comment"># 可以理解为就是pending的一个getter方法</span></span><br></pre></td></tr></table></figure>

<p>同样，我们再给<code>pending</code>定义一个<code>setter</code>方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@pending.setter</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pending</span>(<span class="params">self, status</span>):</span></span><br><span class="line">    self._pending = status.value</span><br><span class="line"><span class="comment"># 定义pending的setter方法</span></span><br></pre></td></tr></table></figure>

<p><code>setter</code>方法传入进来的参数其实是枚举类型的，正好与<code>getter</code>方法相反，<code>getter</code>是把数字类型转换成枚举类型，<code>setter</code>方法则是把枚举类型转换成数字类型，转换的方法就是在枚举类型后面加上<code>.value</code>获取枚举状态代表的数字状态。</p>
<p>有了<code>getter</code>和<code>setter</code>方法之后我们就可以对代码进行修改了，我们改变鱼漂状态的时候就可以直接使用<code>PendingStatus.redraw</code>了，由于<code>setter</code>的存在，最终的<code>self.pending</code>将会被赋值成数字类型。</p>
<p><img src="https://klause-blog-pictures.oss-cn-shanghai.aliyuncs.com/2019-05-14-144226.jpg" alt="image-20180920100710182"></p>
<p>这里保持了<strong>枚举</strong>优雅的写法，同时我们也可以将<code>enums</code>文件夹中直接使用数字不好的写法改过来，现在这种数字的写法要求外部调用<code>pending_str</code>函数的时候传递进来的<code>status</code>是个数字。我们来看下我们之前的调用<code>pending</code>的时候，<img src="https://klause-blog-pictures.oss-cn-shanghai.aliyuncs.com/2019-05-14-144232.jpg" alt="image-20180920101428073"><br>所以我们<code>pending_str</code>函数里的设计就不再需要<code>1、2、3、4</code>这种数字了，而是可以改成更加易读的变量的名字，在外部调用的时候我们都知道使用<code>PendingStatus.Waiting</code>等来调用，那么在<code>PendingStatus</code>类的内部该如何调用呢？很简单，将<code>Waiting</code>、<code>Success</code>、<code>Reject</code>、<code>Redraw</code>当做是类变量，使用<code>cls.Waiting</code>、<code>cls.Success</code>、<code>cls.Reject</code>、<code>cls.Redraw</code>来调用，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PendingStatus</span>(<span class="params">Enum</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    交易的4种状态</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    Waiting = <span class="number">1</span></span><br><span class="line">    Success = <span class="number">2</span></span><br><span class="line">    Reject = <span class="number">3</span></span><br><span class="line">    Redraw = <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pending_str</span>(<span class="params">cls, status, key</span>):</span></span><br><span class="line">        key_map = &#123;</span><br><span class="line">            cls.Waiting: &#123;</span><br><span class="line">                <span class="string">&#x27;requester&#x27;</span>: <span class="string">&#x27;等待对方邮件&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;gifter&#x27;</span>: <span class="string">&#x27;等待您邮寄&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            cls.Success: &#123;</span><br><span class="line">                <span class="string">&#x27;requester&#x27;</span>: <span class="string">&#x27;对方已邮寄&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;gifter&#x27;</span>: <span class="string">&#x27;您已邮寄&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            cls.Reject: &#123;</span><br><span class="line">                <span class="string">&#x27;requester&#x27;</span>: <span class="string">&#x27;对方已拒绝&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;gifter&#x27;</span>: <span class="string">&#x27;您已拒绝&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            cls.Redraw: &#123;</span><br><span class="line">                <span class="string">&#x27;requester&#x27;</span>: <span class="string">&#x27;对方已撤销&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;gifter&#x27;</span>: <span class="string">&#x27;您已撤销&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> key_map[status][key]</span><br><span class="line"></span><br></pre></td></tr></table></figure>




</li>
</ol>
<blockquote>
<p>七月心语：</p>
<p>很多人说动态语言不容易读懂、不容易维护、非常乱，其实不是这样的。动态语言只不过给了你一种写出很随意代码的能力，让你编码能够更加轻松，但是这并不代表着我们就可以随便或者胡乱的去写代码，该遵守的编程基本素养还是要遵守的，这样才能很好的保证代码的可读性，也可以让代码更容易维护。很多同学会发现动态语言写代码非常的快，但是时间长了之后，这个代码你再去看的时候，你就根本看不懂自己在写什么了。我觉得这个问题不应该让动态语言来背锅，该背的锅还是需要自己来背，还是要培养自己的编程素养。其实我这些年写代码，静态语言写了很多，动态语言也写了很多，我的总体的感受是动态语言其实比静态语言要难很多。所有说我在我的很多课程和文章里，都给大家谈到过，第一门编程语言就目前而言，不是PHP，不是Python，而是Java或者是c#，当你的编程功底积累到一定的程度的时候，写动态语言确实是非常合适的。</p>
</blockquote>
<h4 id="超权现象防范"><a href="#超权现象防范" class="headerlink" title="超权现象防范"></a>超权现象防范</h4><p>现在主要的业务逻辑都编写完了，业务逻辑没什么问题，但是这里有一个很严重的<strong>安全问题</strong>，这个安全问题在很多的业务逻辑里都会存在，叫做<strong>超权</strong>。</p>
<p><img src="https://klause-blog-pictures.oss-cn-shanghai.aliyuncs.com/2019-05-14-144234.jpg" alt="image-20180920132123586"></p>
<p>1号用户修改了不属于它的鱼漂，这是一种不安全的行为，甚至是一个非法的操作。很多同学以为<code>@login_required</code>是可以防止超权的，时间是<code>@login_required</code>是不能防止超权的。超权是需要写单独的代码做相应的处理的。</p>
<p>防范超权其实也很简单，在当前情况下，我们装修要多做一步验证就可以防止超权现象发生：</p>
<ul>
<li>验证传进来的鱼漂<code>did</code>是否属于当前用户</li>
</ul>
<p>这样的话我们只需要在<code>filter_by</code>后面的筛选加一项条件<code>requester_id=current_user.id</code>，这样的话即使用户1改了<code>did</code>传进来那么如果当前用户与该<code>did</code>下的<code>requester_id</code>不相符的话，查询不出鱼漂的，即使能搜到，搜到的也是当前用户下的鱼漂。<img src="https://klause-blog-pictures.oss-cn-shanghai.aliyuncs.com/2019-05-14-144237.jpg" alt="image-20180920133933058"></p>
<h4 id="邮寄成功"><a href="#邮寄成功" class="headerlink" title="邮寄成功"></a>邮寄成功</h4><p>代码很简单，基本与前面思路一致，思维要全面一些</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@web.route(<span class="params"><span class="string">&#x27;/drift/&lt;int:did&gt;/mailed&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mailed_drift</span>(<span class="params">did</span>):</span></span><br><span class="line">    <span class="keyword">with</span> db.auto_commit():</span><br><span class="line">        drift = Drift.query.filter_by(gifter_id=current_user.<span class="built_in">id</span>, <span class="built_in">id</span>=did).first_or_404()</span><br><span class="line">        drift.pending = PendingStatus.Success</span><br><span class="line">        current_user.beans += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        gift = Gift.query.filter_by(<span class="built_in">id</span>=drift.gift_id, launched=<span class="literal">False</span>).first_or_404()</span><br><span class="line">        gift.launched = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># wish = Wish.query.filter_by(uid=drift.requester_id, isbn=drift.isbn, launched=False).first_or_404()</span></span><br><span class="line">        <span class="comment"># wish.launched = True</span></span><br><span class="line"></span><br><span class="line">        Wish.query.filter_by(uid=drift.requester_id, isbn=drift.isbn, launched=<span class="literal">False</span>).update(&#123;Wish.launched: <span class="literal">True</span>&#125;)</span><br><span class="line">        <span class="comment"># 第二种写法</span></span><br><span class="line">        <span class="comment"># 建议在实际开发中保持一种写法，两种写法效果相等</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;web.pending&#x27;</span>))</span><br></pre></td></tr></table></figure>



<h4 id="撤销礼物"><a href="#撤销礼物" class="headerlink" title="撤销礼物"></a>撤销礼物</h4><p>思路很简单<img src="https://klause-blog-pictures.oss-cn-shanghai.aliyuncs.com/2019-05-14-144239.jpg" alt="image-20180920155601328"></p>
<p>代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@web.route(<span class="params"><span class="string">&#x27;/gifts/&lt;gid&gt;/redraw&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">redraw_from_gifts</span>(<span class="params">gid</span>):</span></span><br><span class="line">    gift = Gift.query.filter_by(<span class="built_in">id</span>=gid, uid=current_user.<span class="built_in">id</span>, launched=<span class="literal">False</span>).first_or_404()</span><br><span class="line">    drift = Drift.query.filter_by(gift_id=gid, pending=PendingStatus.Waiting).first()</span><br><span class="line">    <span class="keyword">if</span> drift:</span><br><span class="line">        flash(<span class="string">&#x27;这个礼物正处于交易状态，请先前往鱼漂完成该交易!&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> db.auto_commit():</span><br><span class="line">            current_user.beans -= current_app.config[<span class="string">&#x27;BEANS_UPLOAD_ONE_BOOK&#x27;</span>]</span><br><span class="line">            gift.delete()</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;web.my_gifts&#x27;</span>))</span><br></pre></td></tr></table></figure>





<h4 id="撤销心愿"><a href="#撤销心愿" class="headerlink" title="撤销心愿"></a>撤销心愿</h4><p>思路<img src="https://klause-blog-pictures.oss-cn-shanghai.aliyuncs.com/2019-05-14-144241.jpg" alt="image-20180920160215170"></p>
<p>代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@web.route(<span class="params"><span class="string">&#x27;/wish/book/&lt;isbn&gt;/redraw&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">redraw_from_wish</span>(<span class="params">isbn</span>):</span></span><br><span class="line">    wish = Wish.query.filter_by(isbn=isbn, uid=current_user.<span class="built_in">id</span>).first_or_404()</span><br><span class="line">    <span class="keyword">with</span> db.auto_commit():</span><br><span class="line">        wish.delete()</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;web.my_wish&#x27;</span>))</span><br></pre></td></tr></table></figure>





<h4 id="向他人赠送书籍"><a href="#向他人赠送书籍" class="headerlink" title="向他人赠送书籍"></a>向他人赠送书籍</h4><p><img src="https://klause-blog-pictures.oss-cn-shanghai.aliyuncs.com/2019-05-14-144243.jpg" alt="image-20180921101752154"></p>
<p>判断赠书条件：</p>
<ul>
<li>当前用户拥有该本书籍的<code>Gift</code></li>
</ul>
<p>代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@web.route(<span class="params"><span class="string">&#x27;/satisfy/wish/&lt;int:wid&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">satisfy_wish</span>(<span class="params">wid</span>):</span></span><br><span class="line">    wish = Wish.query.get_or_404(wid)</span><br><span class="line">    gift = Gift.query.filter_by(uid=current_user.<span class="built_in">id</span>, isbn=wish.isbn).first_or_404()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> gift:</span><br><span class="line">        flash(<span class="string">&#x27;你还没有上传本书，请点击&quot;加入到赠送清单&quot;添加此书.添加前，请确保自己可以赠送此书&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        send_email(wish.user.email, <span class="string">&#x27;有人想送你一本书&#x27;</span>, <span class="string">&#x27;email/satisfy_wish.html&#x27;</span>, gift=gift, wish=wish)</span><br><span class="line">        flash(<span class="string">&#x27;已向他/她发送了一封邮件，如果他/她愿意接收你的赠送，你将收到一个鱼漂。&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;web.book_detail&#x27;</span>, isbn=wish.isbn))</span><br></pre></td></tr></table></figure>


                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">湮灭星空</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.klause.cn/2019/04/12/Python%20Flask%20%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B%E8%A7%86%E9%A2%91%E7%AC%94%E8%AE%B0/Python%20Flask%20%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B%E8%A7%86%E9%A2%91%E7%AC%94%E8%AE%B02/">https://www.klause.cn/2019/04/12/Python%20Flask%20%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B%E8%A7%86%E9%A2%91%E7%AC%94%E8%AE%B0/Python%20Flask%20%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B%E8%A7%86%E9%A2%91%E7%AC%94%E8%AE%B02/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">湮灭星空</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/python/">
                                    <span class="chip bg-color">python</span>
                                </a>
                            
                                <a href="/tags/flask/">
                                    <span class="chip bg-color">flask</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '9eb5bc3ac1e1ff3ddac0',
        clientSecret: '4b7ae28042282281295075c2bf0c97ff1791cfeb',
        repo: 'HexoBlogComments',
        owner: 'Annihilater',
        admin: "Annihilater",
        id: '2019-04-12T20-37-32',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/04/13/Python/Python%20%E5%87%BA%E7%8E%B0%20Missing%20dependencies%20for%20SOCKS%20support%20%E9%94%99%E8%AF%AF%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/medias/featureimages/5.jpg" class="responsive-img" alt="Python 出现 Missing dependencies for SOCKS support 错误的解决方案">
                        
                        <span class="card-title">Python 出现 Missing dependencies for SOCKS support 错误的解决方案</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2019-04-13
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Tech/" class="post-category">
                                    Tech
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/markdown/">
                        <span class="chip bg-color">markdown</span>
                    </a>
                    
                    <a href="/tags/python/">
                        <span class="chip bg-color">python</span>
                    </a>
                    
                    <a href="/tags/pip/">
                        <span class="chip bg-color">pip</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/04/12/Python%20Flask%20%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B%E8%A7%86%E9%A2%91%E7%AC%94%E8%AE%B0/Python%20Flask%20%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B%E8%A7%86%E9%A2%91%E7%AC%94%E8%AE%B01/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/medias/featureimages/11.jpg" class="responsive-img" alt="Python Flask 高级编程视频笔记1">
                        
                        <span class="card-title">Python Flask 高级编程视频笔记1</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2019-04-12
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/fisher/" class="post-category">
                                    fisher
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/python/">
                        <span class="chip bg-color">python</span>
                    </a>
                    
                    <a href="/tags/flask/">
                        <span class="chip bg-color">flask</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 湮灭星空<br />'
            + '文章作者: 湮灭星空<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2020</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">湮灭星空</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
            <span id="icp"><img src="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/medias/icp.png" style="vertical-align: text-bottom;" />
                <a href="http://www.beian.miit.gov.cn" target="_blank">皖ICP备18005729号-1</a>
            </span>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/Annihilater" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:yanmiexingkong@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>





    <a href="https://twitter.com" class="tooltipped" target="_blank" data-tooltip="关注我的Twitter: https://twitter.com" data-position="top" data-delay="50">
        <i class="fab fa-twitter"></i>
    </a>







    <a href="https://www.zhihu.com" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">知</i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="https://cdn.jsdelivr.net/gh/Annihilater/Annihilater.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
